Давай разберём **пессимистичный** и **оптимистичный** локи на уровне senior-разработчика с примерами и под капотом.

---

## **1. Пессимистичный лок (Pessimistic Lock)**

**Идея:**
Мы предполагаем, что **конфликты вероятны**, поэтому сразу блокируем ресурс для других потоков/транзакций, пока не закончим работу с ним.

**Как работает:**

* Поток A захватывает лок (например, через `lock`, `Monitor.Enter`, `Mutex` или SQL `SELECT ... FOR UPDATE`).
* Другие потоки, которые хотят получить этот ресурс, **блокируются** до освобождения локa.
* После завершения работы поток освобождает лок.

**Пример в C#:**

```csharp
object _lock = new object();

lock (_lock)  // пессимистичный лок
{
    // критическая секция, доступ к shared ресурсу
    sharedData++;
}
```

**В БД (например, SQL):**

```sql
BEGIN TRANSACTION;
SELECT * FROM Accounts WHERE Id = 1 FOR UPDATE;  -- блокируем строку
UPDATE Accounts SET Balance = Balance - 100 WHERE Id = 1;
COMMIT;
```

**Особенности:**

* Надёжно предотвращает race condition.
* Может приводить к **deadlock** и снижению производительности, если много потоков ждут.

---

## **2. Оптимистичный лок (Optimistic Lock)**

**Идея:**
Мы предполагаем, что **конфликты редки**, поэтому не блокируем ресурс, а проверяем **при сохранении**, не изменился ли он.

**Как работает:**

* Поток читает ресурс вместе с **версией** (например, `Version` или `RowVersion` в БД).
* Поток выполняет работу **без блокировки**.
* При сохранении проверяется, что версия не изменилась:

  * Если версия совпадает → сохраняем.
  * Если версия изменилась → откат и повтор попытки.

**Пример в C# с EF Core:**

```csharp
var account = dbContext.Accounts.First(a => a.Id == 1);
account.Balance -= 100;

try
{
    dbContext.SaveChanges();  // проверка версии (RowVersion)
}
catch (DbUpdateConcurrencyException)
{
    // кто-то другой обновил объект, повторить или отменить
}
```

**В БД (SQL Server, PostgreSQL):**

```sql
UPDATE Accounts
SET Balance = Balance - 100, Version = Version + 1
WHERE Id = 1 AND Version = 5;
```

Если строка не обновилась (`Version` изменился) — значит, конфликт, нужно retry.

**Особенности:**

* Отлично подходит для **редко конфликтующих ресурсов**.
* Нет блокировок → высокая производительность.
* Нужно обрабатывать конфликты (retry logic).

---

### **Сравнительная таблица**

| Параметр                  | Пессимистичный лок              | Оптимистичный лок               |
| ------------------------- | ------------------------------- | ------------------------------- |
| Подход                    | Заблокировать заранее           | Проверить при сохранении        |
| Когда использовать        | Высокая конкуренция             | Низкая конкуренция              |
| Потери производительности | Потенциально большие (ожидание) | Минимальные (нет блокировок)    |
| Deadlock                  | Возможен                        | Почти нет                       |
| Сложность реализации      | Низкая                          | Средняя (нужен контроль версии) |

---
